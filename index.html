<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Complet FSC - AFNOR SPEC 2406</title>
    
    <!-- Librairies externes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4a148c; /* Violet AFNOR */
            --primary-light: #7c43bd;
            --accent: #ffca28; /* Jaune */
            --bg: #f3f4f6;
            --text: #1f2937;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            line-height: 1.5;
        }

        /* --- HEADER --- */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; }
        header p { margin-top: 0.5rem; opacity: 0.9; }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 15px;
        }

        /* --- ACCORDÉONS --- */
        .accordion-item {
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .accordion-header {
            padding: 20px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            border-left: 6px solid var(--primary);
        }

        .accordion-header:hover { background-color: #f9fafb; }
        
        .accordion-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accordion-icon { transition: transform 0.3s; color: #9ca3af; }
        .accordion-header.active .accordion-icon { transform: rotate(180deg); color: var(--primary); }
        .accordion-header.active { background-color: #f3e5f5; }

        .accordion-content {
            display: none;
            padding: 20px;
            background: #fff;
            animation: slideDown 0.3s ease-out;
        }
        .accordion-content.show { display: block; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- BLOCS CONSEILS DETAILLÉS --- */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-box {
            border-radius: 8px;
            padding: 20px;
            font-size: 0.9rem;
        }

        .box-tips { background-color: var(--success-bg); border: 1px solid #bbf7d0; }
        .box-errors { background-color: var(--danger-bg); border: 1px solid #fecaca; }

        .detail-box h4 {
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .box-tips h4 { color: var(--success-text); }
        .box-errors h4 { color: var(--danger-text); }

        .detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .detail-list li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 10px;
            color: #374151;
        }

        .box-tips .detail-list li::before { content: "✓"; position: absolute; left: 0; color: var(--success-text); font-weight: bold; }
        .box-errors .detail-list li::before { content: "✗"; position: absolute; left: 0; color: var(--danger-text); font-weight: bold; }

        /* --- QUESTIONS --- */
        .questions-wrapper {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-top: 1px solid #e5e7eb;
        }

        .question-row {
            margin-bottom: 20px;
        }
        .question-row:last-child { margin-bottom: 0; }

        .question-label { font-weight: 600; margin-bottom: 8px; display: block; }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type=range] {
            flex: 1;
            accent-color: var(--primary);
            cursor: pointer;
            height: 6px;
        }

        .score-display {
            background: var(--primary);
            color: white;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 20px;
            min-width: 35px;
            text-align: center;
        }

        /* --- ACTION BTN --- */
        .btn-main {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 40px auto;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(74, 20, 140, 0.3);
            transition: transform 0.2s;
        }
        .btn-main:hover { transform: translateY(-2px); background: var(--primary-light); }

        /* --- RAPPORT --- */
        #report-view {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .analysis-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .score-bar-bg {
            background: #e5e7eb;
            height: 10px;
            border-radius: 5px;
            margin-top: 8px;
            overflow: hidden;
        }
        .score-bar-fill {
            height: 100%;
            background: var(--primary);
            transition: width 1s ease;
        }

        /* --- RESPONSIVE & PRINT --- */
        @media (max-width: 768px) {
            .details-grid, .report-grid { grid-template-columns: 1fr; }
        }

        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            header, .btn-main, .no-print { display: none !important; }
            #report-view { display: block !important; box-shadow: none; margin: 0; padding: 0; }
            .container { margin: 0; max-width: 100%; }
            /* Force l'affichage des détails en impression */
            .details-grid { display: block; }
            .detail-box { border: 1px solid #ccc; margin-bottom: 10px; break-inside: avoid; }
        }
    </style>
</head>
<body>

<header>
    <h1><i class="fas fa-tasks"></i> Diagnostic Complet FSC</h1>
    <p>Conforme au Guide AFNOR SPEC 2406 (Version Décembre 2025)</p>
</header>

<div class="container">

    <!-- Section Formulaire -->
    <div id="audit-interface">
        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid var(--accent);">
            <i class="fas fa-info-circle"></i> <strong>Mode d'emploi :</strong> Déroulez chaque axe pour consulter les recommandations détaillées du guide, puis évaluez votre maturité de 1 (Faible) à 5 (Forte).
        </div>

        <form id="auditForm"></form>

        <button type="button" class="btn-main" onclick="generateReport()">
            <i class="fas fa-chart-pie"></i> Générer l'Analyse et le Rapport
        </button>
    </div>

    <!-- Section Rapport -->
    <div id="report-view">
        <div style="text-align: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px;">
            <h2 style="color:var(--primary); margin:0;">Rapport de Culture de Sécurité des Aliments</h2>
            <p style="color:#666;">Date de l'évaluation : <span id="report-date"></span></p>
            <div style="font-size: 3rem; font-weight: 800; color: var(--primary); margin: 10px 0;">
                <span id="final-score">0</span><span style="font-size: 1.5rem; color: #9ca3af;">/5</span>
            </div>
            <div id="final-verdict" style="font-weight: 600; font-size: 1.2rem;"></div>
        </div>

        <div class="report-grid">
            <div>
                <canvas id="radarChart"></canvas>
            </div>
            <div id="scores-list">
                <!-- Liste des scores générée via JS -->
            </div>
        </div>

        <div style="margin-top: 40px; padding: 20px; background: #f8fafc; border-radius: 8px;">
            <h4><i class="fas fa-lightbulb"></i> Note de synthèse</h4>
            <p>Ce diagnostic est basé sur les 5 piliers de l'AFNOR SPEC 2406. Pour améliorer votre score, référez-vous aux onglets "Conseils" de l'étape précédente pour les axes ayant obtenu une note inférieure à 3/5.</p>
        </div>

        <div class="no-print" style="text-align: center; margin-top: 40px; display: flex; gap: 10px; justify-content: center;">
            <button class="btn-main" style="width: auto; margin: 0; background: #333;" onclick="window.print()">
                <i class="fas fa-print"></i> Imprimer / PDF
            </button>
            <button class="btn-main" style="width: auto; margin: 0; background: white; color: #333; border: 1px solid #ccc;" onclick="location.reload()">
                <i class="fas fa-redo"></i> Nouveau Diagnostic
            </button>
        </div>
    </div>

</div>

<script>
    /* 
     * BASE DE DONNÉES COMPLÈTE AFNOR SPEC 2406
     * Agrégation des Chapitres 2, 3 et Annexe B
     */
    const afnorData = [
        {
            id: "leadership",
            title: "1. Leadership & Rôle Moteur",
            icon: "fa-chess-king",
            // Sources: Chap 2.1 (Règlement), 2.3 (Rôles), 3.4 (Amélioration continue)
            conseils: [
                "Intégrer la sécurité des aliments à la mission, la stratégie et les valeurs de l'entreprise.",
                "Démontrer par l'exemple (Walk the talk) : être cohérent dans les décisions impliquant production vs sécurité.",
                "Ne pas accepter la récurrence des fautes : sanctionner si besoin, mais récompenser les bonnes pratiques.",
                "Mettre en place une veille réglementaire active (lire, comprendre, traduire en exigences).",
                "Intégrer la dimension culturelle dans les revues de direction.",
                "Assurer que l'amélioration continue est une dynamique partagée par tous (pas seulement Qualité).",
                "Prioriser les actions d'amélioration selon leur impact réel sur la sécurité."
            ],
            erreurs: [
                "Donner l'autorisation de libérer un lot douteux pour éviter des pertes financières (Éthique).",
                "Considérer que la veille réglementaire se résume à lister des textes sans les traduire en actions.",
                "Ne pas accorder les ressources nécessaires pour respecter les exigences (conflit de moyens).",
                "Avoir une approche 'Top-Down' unique pour l'amélioration continue.",
                "Raisonner sur un espace-temps court-terme au détriment de la pérennité.",
                "Se focaliser sur la recherche d'un coupable en cas de dysfonctionnement."
            ],
            questions: [
                {id: "RM1", text: "La direction fixe des objectifs clairs en matière de sécurité alimentaire."},
                {id: "RM2", text: "La direction fait clairement part de ses attentes à l'égard des salariés."},
                {id: "RM3", text: "La direction motive les salariés à travailler dans le respect de la sécurité."},
                {id: "RM4", text: "La direction donne l’exemple (hygiène, comportement)."},
                {id: "RM5", text: "Les questions de sécurité sont traitées rapidement et constructivement."},
                {id: "RM6", text: "La direction s’efforce d’améliorer constamment la sécurité."}
            ]
        },
        {
            id: "communication",
            title: "2. Communication",
            icon: "fa-bullhorn",
            // Sources: Chap 3.3 (Communication) + Gestion de crise
            conseils: [
                "Établir un plan de communication interne et externe dédié à la sécurité des aliments.",
                "Adapter le discours au public (vocabulaire simple pour les opérateurs).",
                "Instituer des rituels d'échange (briefs) incluant systématiquement la sécurité.",
                "Utiliser des supports visuels variés (Affiches, écrans, flash info).",
                "Créer un climat de 'Sécurité Psychologique' : permettre de s'exprimer sans peur.",
                "En cas de crise : Avoir un porte-parole formé, ne pas mentir, communiquer en interne."
            ],
            erreurs: [
                "Utiliser un jargon trop technique ou inadapté.",
                "Limiter la communication à l'équipe d'encadrement.",
                "Omettre la sécurité des aliments dans les rituels habituels de l'entreprise.",
                "Surcharger les tableaux d'affichage (trop d'infos tue l'info).",
                "Communiquer uniquement sur les difficultés/incidents (négatif).",
                "Être incohérent : dire 'Sécurité d'abord' mais agir différemment sous pression.",
                "En crise : Fuir les médias ou avoir une attitude agressive."
            ],
            questions: [
                {id: "C1", text: "La direction communique régulièrement sur la sécurité alimentaire."},
                {id: "C2", text: "La communication est claire et compréhensible par tous."},
                {id: "C3", text: "Les salariés peuvent remonter des infos à la direction sans crainte."},
                {id: "C4", text: "L’importance de la sécurité est rappelée visuellement en permanence."},
                {id: "C5", text: "Je peux discuter librement de problèmes de sécurité avec mes collègues."}
            ]
        },
        {
            id: "implication",
            title: "3. Implication & Engagement",
            icon: "fa-users",
            // Sources: Chap 3.2 (Implication)
            conseils: [
                "Rendre les employés fiers de leurs résultats et comportements.",
                "Encourager le signalement des 'quasi-accidents' et des doutes.",
                "Intégrer les salariés (terrain) aux recherches de causes lors d'incidents.",
                "Définir des objectifs individuels liés à la sécurité pour que chacun comprenne sa contribution.",
                "Expliquer les conséquences concrètes d'un comportement à risque (ex: bris de verre = projection à 3m).",
                "Mettre en place un système de reconnaissance/récompense pour les bonnes initiatives."
            ],
            erreurs: [
                "Ne pas faire de retour au personnel suite à un signalement (démotivant).",
                "Ignorer les remontées terrain ou les idées des collaborateurs.",
                "Se concentrer uniquement sur les indicateurs financiers.",
                "Limiter les objectifs individuels à l'encadrement.",
                "Prendre uniquement des mesures disciplinaires sans analyser les causes racines."
            ],
            questions: [
                {id: "E1", text: "Je suis convaincu de l’importance de la sécurité alimentaire."},
                {id: "E2", text: "Mes collègues en sont également convaincus."},
                {id: "E3", text: "Le travail respectueux de la sécurité est reconnu et récompensé."},
                {id: "E4", text: "Je pense pouvoir contribuer personnellement à la sécurité des produits."},
                {id: "E5", text: "Je suis motivé(e) pour atteindre un haut niveau de sécurité."},
                {id: "E6", text: "Je me sens responsable de la sécurité de nos produits."}
            ]
        },
        {
            id: "formation",
            title: "4. Sensibilisation & Compétences",
            icon: "fa-graduation-cap",
            // Sources: Chap 3.1 (Formation/Sensibilisation)
            conseils: [
                "Identifier les besoins pour TOUS les collaborateurs (intérimaires et direction inclus).",
                "Privilégier les mises en situation concrètes (terrain) plutôt que la théorie seule.",
                "Aborder les effets potentiels d'une crise (Toxi-infection) pour donner du sens.",
                "Evaluer l'efficacité 'à froid' (observation des comportements après retour au poste).",
                "S'assurer de l'entretien des connaissances (lutter contre l'oubli).",
                "Accompagner par du tutorat ou du coaching terrain."
            ],
            erreurs: [
                "Intégrer uniquement les équipes opérationnelles (oublier les achats, maintenance...).",
                "Ne pas adapter le contenu aux spécificités de l'entreprise.",
                "Considérer que la formation suffit à créer une culture.",
                "Ne pas allouer assez de temps à la réalisation de la formation.",
                "Négliger l'accompagnement post-formation."
            ],
            questions: [
                {id: "S1", text: "Je connais les risques liés à mes tâches spécifiques."},
                {id: "S2", text: "Mes collègues connaissent les risques liés à leurs tâches."},
                {id: "S3", text: "Nous sommes attentifs aux problèmes et risques potentiels."},
                {id: "S4", text: "La direction a une image réaliste des problèmes terrain."},
                {id: "S5", text: "Les risques liés à la sécurité alimentaire sont maîtrisés ici."}
            ]
        },
        {
            id: "ressources",
            title: "5. Ressources & Gestion du Changement",
            icon: "fa-tools",
            // Sources: Chap 2.2 (Ressources) et 2.4 (Maîtrise des changements)
            conseils: [
                "Aligner les règles d'hygiène avec l'état des locaux (ex: ne pas demander l'impossible si le matériel est vétuste).",
                "Identifier les équipements critiques et prioriser leur maintenance.",
                "Intégrer l'expertise opérationnelle dans les décisions d'achat ou de travaux.",
                "Mettre en place une équipe pluridisciplinaire pour analyser les risques avant un changement.",
                "Documenter systématiquement les changements et mettre à jour le plan de maîtrise sanitaire.",
                "Garantir la continuité des missions lors des absences."
            ],
            erreurs: [
                "Ne pas prendre en compte le volet 'sécurité des aliments' lors de modifications techniques.",
                "Décider d'un changement (recette/équipement) sans informer l'équipe HACCP.",
                "Ne pas évaluer les risques lors d'un changement d'urgence.",
                "Avoir un système figé et non évolutif.",
                "Sous-estimer les délais de mise en conformité."
            ],
            questions: [
                {id: "R1", text: "Les salariés disposent de suffisamment de temps pour respecter la sécurité."},
                {id: "R2", text: "Des effectifs suffisants sont disponibles."},
                {id: "R3", text: "L’infrastructure et les équipements permettent de bien travailler."},
                {id: "R4", text: "Les ressources financières sont suffisantes (maintenance, nettoyage, labo)."},
                {id: "R5", text: "Une éducation et une formation suffisantes sont dispensées."},
                {id: "R6", text: "De bonnes procédures et instructions sont en place."}
            ]
        }
    ];

    // --- LOGIQUE JS ---
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
        renderForm();
    });

    function renderForm() {
        const formContainer = document.getElementById('auditForm');
        
        afnorData.forEach(section => {
            const html = `
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title">
                            <i class="fas ${section.icon}"></i> ${section.title}
                        </div>
                        <i class="fas fa-chevron-down accordion-icon"></i>
                    </div>
                    
                    <div class="accordion-content">
                        <!-- Zone Conseils/Erreurs -->
                        <div class="details-grid">
                            <div class="detail-box box-tips">
                                <h4><i class="fas fa-check-circle"></i> Conseils du Guide</h4>
                                <ul class="detail-list">
                                    ${section.conseils.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="detail-box box-errors">
                                <h4><i class="fas fa-exclamation-triangle"></i> Pièges à éviter</h4>
                                <ul class="detail-list">
                                    ${section.erreurs.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- Zone Questions -->
                        <div class="questions-wrapper">
                            ${section.questions.map((q, idx) => `
                                <div class="question-row">
                                    <label class="question-label">${q.id} - ${q.text}</label>
                                    <div class="slider-group">
                                        <span style="font-size:0.8rem; color:#6b7280;">Non</span>
                                        <input type="range" min="1" max="5" value="3" step="1" 
                                               name="${section.id}" oninput="updateScore(this)">
                                        <span style="font-size:0.8rem; color:#6b7280;">Oui</span>
                                        <div class="score-display">3</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            formContainer.insertAdjacentHTML('beforeend', html);
        });
    }

    function toggleAccordion(header) {
        // Optionnel: fermer les autres accordéons pour plus de clarté
        document.querySelectorAll('.accordion-header').forEach(h => {
            if(h !== header && h.classList.contains('active')) {
                h.classList.remove('active');
                h.nextElementSibling.classList.remove('show');
            }
        });

        header.classList.toggle('active');
        const content = header.nextElementSibling;
        content.classList.toggle('show');
    }

    function updateScore(input) {
        input.parentElement.querySelector('.score-display').innerText = input.value;
    }

    function generateReport() {
        // 1. Calculs
        const scores = [];
        const labels = [];
        let totalSum = 0;
        let countSections = 0;
        
        let reportListHTML = '';

        afnorData.forEach(section => {
            const inputs = document.getElementsByName(section.id);
            let sum = 0;
            inputs.forEach(inp => sum += parseInt(inp.value));
            let avg = (sum / inputs.length).toFixed(1);
            
            scores.push(avg);
            labels.push(section.title.split('. ')[1]); // Titre court
            totalSum += parseFloat(avg);
            countSections++;

            // Génération liste rapport
            let color = avg >= 4 ? 'var(--success-text)' : (avg < 3 ? 'var(--danger-text)' : '#d97706');
            let widthPct = (avg / 5) * 100;
            
            reportListHTML += `
                <div class="analysis-item">
                    <div style="display:flex; justify-content:space-between; font-weight:600;">
                        <span>${section.title}</span>
                        <span style="color:${color}">${avg}/5</span>
                    </div>
                    <div class="score-bar-bg">
                        <div class="score-bar-fill" style="width:${widthPct}%; background-color:${color}"></div>
                    </div>
                    <div style="font-size:0.85rem; margin-top:5px; color:#666;">
                        ${avg < 3 ? '<i class="fas fa-exclamation-circle"></i> Axe critique : consultez les pièges à éviter.' : ''}
                    </div>
                </div>
            `;
        });

        const finalScore = (totalSum / countSections).toFixed(1);
        
        // 2. Affichage DOM
        document.getElementById('audit-interface').style.display = 'none';
        document.getElementById('report-view').style.display = 'block';
        document.getElementById('scores-list').innerHTML = reportListHTML;
        document.getElementById('final-score').innerText = finalScore;
        document.getElementById('report-date').innerText = new Date().toLocaleDateString('fr-FR');

        // Verdict textuel
        const verdictEl = document.getElementById('final-verdict');
        if(finalScore >= 4) {
            verdictEl.innerHTML = "<span style='color:green'>Excellent niveau de maturité culturelle.</span>";
        } else if(finalScore >= 3) {
            verdictEl.innerHTML = "<span style='color:orange'>Bon niveau, mais des efforts d'implication sont nécessaires.</span>";
        } else {
            verdictEl.innerHTML = "<span style='color:red'>Niveau fragile. Une action prioritaire de la direction est requise.</span>";
        }

        // 3. Graphique Radar
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Niveau de Maturité',
                    data: scores,
                    backgroundColor: 'rgba(74, 20, 140, 0.2)',
                    borderColor: '#4a148c',
                    pointBackgroundColor: '#ffca28',
                    pointBorderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { display: true },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        window.scrollTo(0,0);
    }
</script>

</body>
</html>
